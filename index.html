<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inventário - SILOKING</title>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --muted:#5b677a;
  --text:#0f172a;
  --accent:#2563eb;
  --ok:#16a34a;
  --bad:#dc2626;
  --line:rgba(15,23,42,.10);
  --shadow:0 12px 30px rgba(15,23,42,.08);
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#ffffff, var(--bg));
  color:var(--text);
}
.wrap{max-width:1200px;margin:0 auto;padding:18px;}
.header{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:22px;
  padding:14px 16px;
  box-shadow:var(--shadow);
  display:flex;justify-content:space-between;align-items:center;
}
.grid{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:var(--shadow);
}
.cardTitle{font-weight:900;margin-bottom:10px;font-size:14px;}
input,button{
  width:100%;
  border-radius:16px;
  border:1px solid var(--line);
  padding:12px;
  font-size:16px;
}
button{cursor:pointer;font-weight:900;border:0}
.primary{background:var(--accent);color:#fff;}
.danger{background:#fff1f2;color:var(--bad);border:1px solid #fecaca;}
.tableWrap{overflow:auto;max-height:500px;border-radius:16px;border:1px solid var(--line);}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #eee;font-size:13px;}
th{background:#f8fafc;}
.row2{display:grid;grid-template-columns:1fr 120px;gap:10px;}
</style>
</head>

<body>
<div class="wrap">

<div class="header">
<h2>Inventário por Posição</h2>
<div id="posicaoInfo">Posição: —</div>
</div>

<div class="grid">

<div class="card">
<div class="cardTitle">Selecionar posição</div>

<input id="inputPosicao" placeholder="Digite B42 ou B-42"/>
<br><br>
<button class="primary" onclick="buscarPosicao()">Buscar posição</button>
<br><br>
<button onclick="salvar()">Salvar contagem</button>
<br><br>
<button onclick="exportar()">Exportar CSV</button>
<br><br>
<button class="danger" onclick="zerar()">Zerar posição</button>

<hr style="margin:20px 0">

<label>Bipar código</label>
<div class="row2">
<input id="codigo" placeholder="Bipe aqui..."/>
<input id="quantidade" type="number" value="1"/>
</div>
<br>
<button class="primary" onclick="bipar()">Adicionar</button>

</div>

<div class="card">
<div class="cardTitle">Itens da posição</div>
<div class="tableWrap">
<table>
<thead>
<tr>
<th>Código</th>
<th>Nome</th>
<th>Quantidade</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

</div>
</div>

<script>
const URL_JSON = "./produtos.json";
let base = [];
let inventario = {};
let posicaoAtual = "";

function normalizar(p){
return String(p||"").toUpperCase().replace(/-/g,"").trim();
}

function chave(p){
return "inv_"+normalizar(p);
}

async function carregarBase(){
const res = await fetch(URL_JSON);
base = await res.json();
}

function buscarPosicao(){
const pos = normalizar(document.getElementById("inputPosicao").value);
if(!pos){alert("Digite uma posição");return;}

posicaoAtual = pos;
document.getElementById("posicaoInfo").innerText = "Posição: "+pos;

inventario = {};

base.forEach(p=>{
if(normalizar(p.posicao) === pos){
inventario[p.codigo] = {
codigo:p.codigo,
nome:p.nome,
qtd:0
};
}
});

const salvo = localStorage.getItem(chave(pos));
if(salvo){
inventario = JSON.parse(salvo);
}

render();
}

function bipar(){
const cod = document.getElementById("codigo").value.trim();
const qtd = parseInt(document.getElementById("quantidade").value) || 1;

if(!inventario[cod]){
alert("Produto não pertence a essa posição!");
return;
}

inventario[cod].qtd += qtd;

document.getElementById("codigo").value="";
document.getElementById("quantidade").value=1;

render();
}

function render(){
const tbody = document.getElementById("tbody");
tbody.innerHTML="";

Object.values(inventario).forEach(item=>{
const tr = document.createElement("tr");
tr.innerHTML=`
<td>${item.codigo}</td>
<td>${item.nome}</td>
<td>${item.qtd}</td>
`;
tbody.appendChild(tr);
});
}

function salvar(){
if(!posicaoAtual)return;
localStorage.setItem(chave(posicaoAtual), JSON.stringify(inventario));
alert("Salvo com sucesso!");
}

function zerar(){
if(!posicaoAtual)return;
if(confirm("Deseja zerar essa posição?")){
localStorage.removeItem(chave(posicaoAtual));
buscarPosicao();
}
}

function exportar(){
if(!posicaoAtual)return;

let linhas=["Codigo;Nome;Quantidade"];
Object.values(inventario).forEach(i=>{
linhas.push(`${i.codigo};${i.nome};${i.qtd}`);
});

const blob = new Blob(["\ufeff"+linhas.join("\n")],{type:"text/csv"});
const a = document.createElement("a");
a.href = URL.createObjectURL(blob);
a.download = "Inventario_"+posicaoAtual+".csv";
a.click();
}

carregarBase();
</script>

</body>
</html>
