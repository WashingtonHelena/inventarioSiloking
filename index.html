<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventário — SILOKING BRASIL</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#dc2626;
      --danger2:#b91c1c;
      --ok:#16a34a;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #ffffff 0%, var(--bg) 50%, #eef2ff 100%);
      color:var(--text);
    }
    .wrap{
      max-width: 1180px;
      margin: 24px auto;
      padding: 0 16px 28px;
    }

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 16px 18px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 280px;
    }
    .brand svg{display:block}
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height: 1.15;
    }
    .title p{
      margin:0;
      font-size: 13px;
      color: var(--muted);
    }
    .pill{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:12px;
      color:#0f172a;
      background:#eef2ff;
      border:1px solid #dbeafe;
      padding:7px 10px;
      border-radius: 999px;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .tag b{font-weight:700}
    .tag .dot{
      width:9px;height:9px;border-radius:99px;background:var(--ok);
      box-shadow: 0 0 0 4px rgba(22,163,74,.12);
    }

    /* Layout */
    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1.2fr .95fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
      header{flex-direction:column; align-items:flex-start}
      .pill{justify-content:flex-start}
    }

    .card{
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin:0 0 2px 0;
      font-size: 15px;
    }
    .card .sub{
      margin:0 0 12px 0;
      font-size: 13px;
      color: var(--muted);
    }

    label{
      display:block;
      font-size: 13px;
      color:#111827;
      margin: 12px 0 6px;
      font-weight:600;
    }
    input, button{
      font-family: inherit;
    }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size: 16px;
    }
    input:focus{
      border-color:#93c5fd;
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 140px;
      gap: 12px;
      align-items:end;
    }
    @media (max-width: 520px){
      .row{grid-template-columns:1fr}
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .warn{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid #fde68a;
      background:#fffbeb;
      color:#92400e;
      font-size: 13px;
      display:none;
    }
    .warn.show{display:block}

    .btn{
      width:100%;
      border:0;
      border-radius: 16px;
      padding: 12px 12px;
      font-size: 15px;
      font-weight: 700;
      cursor:pointer;
      transition: transform .06s ease, filter .15s ease;
      margin-top: 10px;
    }
    .btn:active{transform: scale(.99)}
    .btn.primary{background: linear-gradient(180deg, var(--primary), var(--primary2)); color:#fff}
    .btn.gray{background:#f3f4f6; border:1px solid var(--line); color:#111827}
    .btn.danger{background: linear-gradient(180deg, var(--danger), var(--danger2)); color:#fff}

    /* Table */
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--line);
      background:#fff;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: #374151;
      background:#f9fafb;
      border-bottom:1px solid var(--line);
      padding: 10px 10px;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom:1px solid #f1f5f9;
      font-size: 13px;
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .mini{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .mini:hover{filter:brightness(.98)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <!-- Logo SILOKING BRASIL (SVG) -->
       <svg width="220" height="62" viewBox="0 0 660 186" xmlns="http://www.w3.org/2000/svg" aria-label="SILOKING BRASIL">
  <!-- Top and bottom blue lines -->
  <rect x="0" y="0" width="420" height="14" fill="#1d4ed8"/>
  <rect x="0" y="172" width="420" height="14" fill="#1d4ed8"/>

  <!-- SILOKING -->
  <text x="12" y="118" font-size="92" font-family="Arial Black, Arial, sans-serif" fill="#dc2626" letter-spacing="3">
    SILOKING
  </text>

  <!-- BRASIL -->
  <text x="18" y="162" font-size="48" font-family="Arial Black, Arial, sans-serif" fill="#dc2626" letter-spacing="18">
    BRASIL
  </text>

  <!-- Circle -->
  <circle cx="560" cy="93" r="80" fill="#ffffff" stroke="#dc2626" stroke-width="16"/>

  <!-- Crown (simples, sem folha e sem bandeira) -->
  <g transform="translate(510,40)">
    <!-- base -->
    <rect x="0" y="72" width="100" height="18" rx="6" fill="#dc2626"/>
    <!-- points -->
    <polygon points="10,72 25,30 40,72" fill="#dc2626"/>
    <polygon points="40,72 50,18 60,72" fill="#dc2626"/>
    <polygon points="60,72 75,30 90,72" fill="#dc2626"/>
    <!-- jewels -->
    <circle cx="25" cy="28" r="6" fill="#ffffff"/>
    <circle cx="50" cy="16" r="6" fill="#ffffff"/>
    <circle cx="75" cy="28" r="6" fill="#ffffff"/>
  </g>
</svg>
      </div>

      <div class="title">
        <h1>Inventário (Bipagem) — com base de produtos</h1>
        <p>Bipe o código e exporte o relatório em CSV (Excel abre direto).</p>
      </div>

      <div class="pill">
        <div class="tag"><span class="dot"></span><b id="baseCount">Base:</b> produtos</div>
        <div class="tag"><b id="savedAt">Último salvamento:</b> —</div>
      </div>
    </header>

    <div class="grid">
      <!-- Left -->
      <section class="card">
        <h2>Entrada</h2>
        <p class="sub">Bipe o código, ajuste a quantidade e clique em <b>OK</b>.</p>

        <div class="row">
          <div>
            <label for="codigo">1) Código (bipado)</label>
            <input id="codigo" class="mono" type="text" autocomplete="off" placeholder="Bipe aqui..." />
          </div>
          <div>
            <label for="qtd">Qtd</label>
            <input id="qtd" class="mono" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <label for="nome">2) Produto encontrado</label>
        <input id="nome" type="text" readonly placeholder="Vai aparecer o nome automaticamente..." />

        <div id="warn" class="warn">⚠️ Código não encontrado na base.</div>

        <button id="btnAdd" class="btn primary">OK</button>
        <button id="btnClear" class="btn gray">Limpar</button>
        <button id="btnZero" class="btn danger">Zerar inventário</button>
        <button id="btnExport" class="btn primary">Exportar CSV (Excel)</button>

        <div class="hint">
          Dica: se seu leitor envia ENTER no final, é só bipar e apertar <b>OK</b>.
        </div>
      </section>

      <!-- Right -->
      <aside class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div>
            <h2>Itens no inventário</h2>
            <p class="sub">Agrupado por código.</p>
          </div>
          <div class="tag"><b id="itemsCount">0</b> itens</div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width: 26%;">Código</th>
              <th>Nome</th>
              <th style="width: 12%;">Qtd</th>
              <th style="width: 20%;">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="small" id="saveInfo"></div>
      </aside>
    </div>
  </div>

<script>
/** ===========================
 *  BASE DE PRODUTOS (JSON)
 *  =========================== */
let baseProdutos = {};
let baseCount = 0;

async function carregarBase(){
  try{
    const res = await fetch("./produtos.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Não achou produtos.json");
    baseProdutos = await res.json();
    baseCount = Object.keys(baseProdutos).length;
    document.getElementById("baseCount").innerHTML = "Base: <b>"+baseCount+"</b> produtos";
  }catch(e){
    baseProdutos = {};
    baseCount = 0;
    document.getElementById("baseCount").innerHTML = "Base: <b>0</b> produtos";
  }
}

/** ===========================
 *  INVENTÁRIO (LOCAL STORAGE)
 *  =========================== */
const LS_KEY = "siloking_inventario_v1";
let inventario = {}; // { codigo: {codigo, nome, qtd} }

function nowBR(){
  const d = new Date();
  return d.toLocaleString("pt-BR");
}

function salvar(){
  localStorage.setItem(LS_KEY, JSON.stringify(inventario));
  const t = nowBR();
  document.getElementById("savedAt").innerHTML = "Último salvamento: <b>"+t+"</b>";
  document.getElementById("saveInfo").textContent = "Último salvamento: " + t;
}

function carregar(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      inventario = JSON.parse(raw) || {};
    }
  }catch(e){
    inventario = {};
  }
}

/** ===========================
 *  UI
 *  =========================== */
const elCodigo = document.getElementById("codigo");
const elQtd = document.getElementById("qtd");
const elNome = document.getElementById("nome");
const elWarn = document.getElementById("warn");
const elTbody = document.getElementById("tbody");
const elItemsCount = document.getElementById("itemsCount");

function normalizarCodigo(v){
  return (v || "").toString().trim();
}

function atualizarNome(){
  const codigo = normalizarCodigo(elCodigo.value);
  if(!codigo){
    elNome.value = "";
    elWarn.classList.remove("show");
    return;
  }

  const nome = baseProdutos[codigo];
  if(nome){
    elNome.value = nome;
    elWarn.classList.remove("show");
  }else{
    elNome.value = "";
    elWarn.classList.add("show");
  }
}

function render(){
  const arr = Object.values(inventario);

  elItemsCount.textContent = arr.length.toString();

  if(arr.length === 0){
    elTbody.innerHTML = `
      <tr>
        <td colspan="4" style="padding:14px; color:#6b7280; font-size:13px;">
          Nenhum item ainda. Bipe um código e clique em <b>OK</b>.
        </td>
      </tr>
    `;
    return;
  }

  elTbody.innerHTML = arr.map(item => `
    <tr>
      <td class="mono">${escapeHtml(item.codigo)}</td>
      <td>${escapeHtml(item.nome || "(não encontrado)")}</td>
      <td class="mono">${item.qtd}</td>
      <td>
        <div class="actions">
          <button class="mini" onclick="mais('${escapeAttr(item.codigo)}')">+1</button>
          <button class="mini" onclick="menos('${escapeAttr(item.codigo)}')">-1</button>
          <button class="mini" onclick="remover('${escapeAttr(item.codigo)}')">Remover</button>
        </div>
      </td>
    </tr>
  `).join("");
}

function escapeHtml(s){
  return (s || "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){
  return (s || "").toString().replaceAll("'","\\'");
}

/** ===========================
 *  AÇÕES
 *  =========================== */
function addItem(){
  const codigo = normalizarCodigo(elCodigo.value);
  let qtd = parseInt(elQtd.value || "1", 10);
  if(!qtd || qtd < 1) qtd = 1;

  if(!codigo){
    elCodigo.focus();
    return;
  }

  const nome = baseProdutos[codigo] || "";

  if(!inventario[codigo]){
    inventario[codigo] = { codigo, nome: nome || "(não encontrado)", qtd: 0 };
  }else{
    // se agora encontrou nome, atualiza
    if(nome) inventario[codigo].nome = nome;
  }

  inventario[codigo].qtd += qtd;

  salvar();
  render();

  // limpa e foca para próximo bip
  elCodigo.value = "";
  elQtd.value = "1";
  elNome.value = "";
  elWarn.classList.remove("show");
  elCodigo.focus();
}

function mais(codigo){
  if(!inventario[codigo]) return;
  inventario[codigo].qtd += 1;
  salvar();
  render();
}
function menos(codigo){
  if(!inventario[codigo]) return;
  inventario[codigo].qtd -= 1;
  if(inventario[codigo].qtd <= 0){
    delete inventario[codigo];
  }
  salvar();
  render();
}
function remover(codigo){
  if(!inventario[codigo]) return;
  delete inventario[codigo];
  salvar();
  render();
}

function limparCampos(){
  elCodigo.value = "";
  elQtd.value = "1";
  elNome.value = "";
  elWarn.classList.remove("show");
  elCodigo.focus();
}

function zerarInventario(){
  if(!confirm("Tem certeza que deseja ZERAR o inventário?")){
    return;
  }
  inventario = {};
  salvar();
  render();
}

function exportarCSV(){
  const itens = Object.values(inventario);
  if(itens.length === 0){
    alert("Inventário vazio. Bipe pelo menos 1 item.");
    return;
  }

  // CSV padrão Excel BR (separador ;)
  let csv = "Codigo;Nome;Quantidade\n";
  for(const it of itens){
    const c = (it.codigo || "").toString().replaceAll(";", " ");
    const n = (it.nome || "").toString().replaceAll(";", " ");
    const q = (it.qtd || 0).toString();
    csv += `${c};${n};${q}\n`;
  }

  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `inventario_siloking_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

/** ===========================
 *  EVENTOS
 *  =========================== */
document.getElementById("btnAdd").addEventListener("click", addItem);
document.getElementById("btnClear").addEventListener("click", limparCampos);
document.getElementById("btnZero").addEventListener("click", zerarInventario);
document.getElementById("btnExport").addEventListener("click", exportarCSV);

elCodigo.addEventListener("input", atualizarNome);

// ENTER adiciona também
elCodigo.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    addItem();
  }
});

(async function init(){
  await carregarBase();
  carregar();
  salvar();
  render();
  elCodigo.focus();
})();
</script>
</body>
</html>
