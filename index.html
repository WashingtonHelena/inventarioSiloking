<script>

let produtos = [];
let contagem = {};
let posicaoAtual = "";

function normalizar(pos) {
    return pos ? pos.toUpperCase().replace("-", "").trim() : "";
}

fetch('./produtos_base_completa.json')
.then(res => res.json())
.then(data => {
    produtos = data;
    document.getElementById("totalBase").innerText = produtos.length;
    document.getElementById("statusBase").innerText = "Base Carregada ‚úî";
});

/* POSI√á√ïES */
function carregarPosicao() {
    posicaoAtual = normalizar(document.getElementById("posicaoInput").value);
    if(!posicaoAtual){
        alert("Digite uma posi√ß√£o v√°lida");
        return;
    }
    document.getElementById("posicaoAtual").innerText = posicaoAtual;
    renderizar();
}

function mostrarSemPosicao(){
    posicaoAtual = "SEM_POSICAO";
    document.getElementById("posicaoAtual").innerText = "SEM POSI√á√ÉO";
    renderizar();
}

function trocarPosicao(){
    posicaoAtual = "";
    contagem = {};
    document.getElementById("tabelaProdutos").innerHTML = "";
    document.getElementById("posicaoAtual").innerText = "Nenhuma";
}

/* RENDER */
function renderizar(){

    const tbody = document.getElementById("tabelaProdutos");
    tbody.innerHTML = "";

    produtos.forEach(prod => {

        let posBase = normalizar(prod.posicao);
        let pertence = posBase === posicaoAtual;
        let ehSem = !prod.posicao || prod.posicao.trim() === "";
        let qtd = contagem[prod.codigo] || 0;

        let mostrar = false;

        if(posicaoAtual === "SEM_POSICAO" && ehSem) mostrar = true;
        else if(pertence) mostrar = true;
        else if(qtd > 0) mostrar = true; // üî• mant√©m fora da posi√ß√£o vis√≠vel

        if(mostrar){

            const tr = document.createElement("tr");

            if(qtd === 0 && pertence) tr.classList.add("zero");
            if(qtd > 0 && pertence) tr.classList.add("contado");
            if(qtd > 0 && !pertence) tr.classList.add("fora");

            tr.innerHTML = `
                <td>${prod.codigo}</td>
                <td>${prod.nome}</td>
                <td>${prod.posicao || "SEM POSI√á√ÉO"}</td>
                <td>${qtd}</td>
            `;

            tbody.appendChild(tr);
        }
    });
}

/* ADICIONAR */
function adicionarProduto(){

    const codigo = document.getElementById("codigoInput").value.trim();
    const qtd = parseInt(document.getElementById("quantidadeInput").value) || 1;

    if(!codigo) return;

    let existe = produtos.find(p => p.codigo === codigo);

    if(!existe){
        alert("Produto n√£o encontrado na base!");
        return;
    }

    contagem[codigo] = (contagem[codigo] || 0) + qtd;

    document.getElementById("codigoInput").value = "";
    document.getElementById("quantidadeInput").value = 1;

    renderizar();
}

/* EXPORTAR */
function exportarCSV(){

    let linhas = [["Posicao_Contada","Codigo","Produto","Posicao_Base_JSON","Quantidade","Status"]];

    produtos.forEach(prod => {

        let posBase = normalizar(prod.posicao);
        let pertence = posBase === posicaoAtual;
        let ehSem = !prod.posicao || prod.posicao.trim() === "";
        let qtd = contagem[prod.codigo] || 0;

        if(qtd > 0){

            let status = pertence ? "OK" : "FORA_POSICAO";

            linhas.push([
                posicaoAtual,
                prod.codigo,
                prod.nome,
                prod.posicao || "SEM POSI√á√ÉO",
                qtd,
                status
            ]);
        }
    });

    let csv = linhas.map(l => l.join(";")).join("\n");

    let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `inventario_${posicaoAtual}.csv`;
    link.click();

    contagem = {};
    renderizar();
}

/* DARK MODE */
function alternarModo(){
    document.body.classList.toggle("dark");
}

</script>
