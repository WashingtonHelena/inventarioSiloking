<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inventário - SILOKING</title>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --muted:#5b677a;
  --text:#0f172a;
  --accent:#2563eb;
  --ok:#16a34a;
  --bad:#dc2626;
  --line:rgba(15,23,42,.10);
  --shadow:0 12px 30px rgba(15,23,42,.08);
  --radius:18px;
}
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#fff,var(--bg));
}
.wrap{max-width:1200px;margin:auto;padding:18px}
.header{
  background:#fff;
  border-radius:20px;
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:var(--shadow);
}
.brand{display:flex;align-items:center;gap:15px}
.logo img{height:55px}
.status{display:flex;align-items:center;gap:8px;color:gray}
.dot{width:12px;height:12px;border-radius:50%;background:#ccc}
.dot.ok{background:var(--ok)}
.grid{margin-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:15px}
.card{
  background:#fff;
  border-radius:20px;
  padding:15px;
  box-shadow:var(--shadow);
}
input,button{
  width:100%;
  padding:10px;
  border-radius:15px;
  border:1px solid #ddd;
  font-size:15px;
}
button{cursor:pointer;font-weight:bold;border:0}
.primary{background:var(--accent);color:#fff}
.danger{background:#fff1f2;color:var(--bad)}
.row2{display:grid;grid-template-columns:1fr 120px;gap:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px}
th{background:#f3f4f6}
.zero{background:#ffe5e5}
.okrow{background:#e5ffe8}
</style>
</head>

<body>
<div class="wrap">

<div class="header">
<div class="brand">
<div class="logo"><img src="logo.png"/></div>
<div>
<h2 style="margin:0">Inventário por Posição</h2>
<div id="posicaoInfo" style="font-size:13px;color:gray">Posição: —</div>
</div>
</div>

<div class="status">
<div id="dotBase" class="dot"></div>
<span id="totalBase">Base: 0 itens</span>
</div>
</div>

<div class="grid">

<div class="card">

<input id="inputPosicao" placeholder="Digite B42 ou B-42"/>
<br><br>
<button class="primary" onclick="buscarPosicao()">Buscar posição</button>
<br><br>
<button onclick="salvar()">Salvar contagem</button>
<br><br>
<button onclick="exportar()">Exportar CSV</button>
<br><br>
<button class="danger" onclick="zerar()">Zerar posição</button>

<hr style="margin:20px 0">

<label>Bipar código</label>
<div class="row2">
<input id="codigo"/>
<input id="quantidade" type="number" value="1"/>
</div>
<br>
<button class="primary" onclick="bipar()">Adicionar</button>

</div>

<div class="card">
<table>
<thead>
<tr>
<th>Código</th>
<th>Nome</th>
<th>Qtd</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>
</div>

<script>
const URL_JSON="./produtos.json";
let base=[];
let baseMap={};
let inventario={};
let posicaoAtual="";

function normalizar(p){
return String(p||"").toUpperCase().replace(/-/g,"").trim();
}

function chave(p){return "inv_"+normalizar(p)}

async function carregarBase(){
const res=await fetch(URL_JSON);
base=await res.json();

base.forEach(p=>{
baseMap[p.codigo]=p;
});

document.getElementById("dotBase").classList.add("ok");
document.getElementById("totalBase").innerText="Base: "+base.length+" itens";
}

function buscarPosicao(){
const pos=normalizar(document.getElementById("inputPosicao").value);
if(!pos)return;

posicaoAtual=pos;
document.getElementById("posicaoInfo").innerText="Posição: "+pos;

inventario={};

base.forEach(p=>{
if(normalizar(p.posicao)===pos){
inventario[p.codigo]={codigo:p.codigo,nome:p.nome,qtd:0,posOriginal:p.posicao};
}
});

const salvo=localStorage.getItem(chave(pos));
if(salvo)inventario=JSON.parse(salvo);

render();
}

function bipar(){
const cod=document.getElementById("codigo").value.trim();
const qtd=parseInt(document.getElementById("quantidade").value)||1;
if(!cod)return;

if(!inventario[cod]){
let baseInfo=baseMap[cod];
inventario[cod]={
codigo:cod,
nome:baseInfo?baseInfo.nome:"(SEM CADASTRO)",
qtd:0,
posOriginal:baseInfo?baseInfo.posicao:"SEM POSIÇÃO"
};
}

inventario[cod].qtd+=qtd;

document.getElementById("codigo").value="";
document.getElementById("quantidade").value=1;

render();
}

function render(){
const tbody=document.getElementById("tbody");
tbody.innerHTML="";

Object.values(inventario).forEach(item=>{
const tr=document.createElement("tr");

if(item.qtd==0)tr.className="zero";
else tr.className="okrow";

tr.innerHTML=`
<td>${item.codigo}</td>
<td>${item.nome}</td>
<td>${item.qtd}</td>
`;
tbody.appendChild(tr);
});
}

function salvar(){
if(!posicaoAtual)return;
localStorage.setItem(chave(posicaoAtual),JSON.stringify(inventario));
alert("Salvo!");
}

function zerar(){
if(!posicaoAtual)return;
localStorage.removeItem(chave(posicaoAtual));
buscarPosicao();
}

function exportar(){
if(!posicaoAtual)return;

let linhas=["Codigo;Nome;Quantidade;Posicao_Contada;Posicao_Original"];

Object.values(inventario).forEach(i=>{
linhas.push(`${i.codigo};${i.nome};${i.qtd};${posicaoAtual};${i.posOriginal}`);
});

const blob=new Blob(["\ufeff"+linhas.join("\n")],{type:"text/csv"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="Inventario_"+posicaoAtual+".csv";
a.click();

zerar(); // zera automaticamente após exportar
}

carregarBase();
</script>

</body>
</html>
