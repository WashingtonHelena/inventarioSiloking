<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inventário - SILOKING</title>

<style>
body{margin:0;font-family:Arial;background:#f5f6fa}
.wrap{max-width:1200px;margin:auto;padding:20px}
.header{background:#fff;padding:15px;border-radius:15px;display:flex;justify-content:space-between;align-items:center}
.card{background:#fff;padding:15px;border-radius:15px;margin-top:15px}
input,button{padding:10px;border-radius:10px;border:1px solid #ccc;font-size:16px}
button{cursor:pointer;font-weight:bold}
.primary{background:#2563eb;color:#fff;border:none}
.danger{background:#dc2626;color:#fff;border:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #eee;padding:8px;font-size:14px}
th{background:#f3f4f6}
</style>
</head>

<body>
<div class="wrap">

<div class="header">
<h2>Inventário por Posição</h2>
<div id="posicaoAtual">Posição: —</div>
</div>

<div class="card">
<input id="inputPosicao" placeholder="Digite B42 ou B-42"/>
<button class="primary" onclick="buscarPosicao()">Buscar posição</button>
<button onclick="salvar()">Salvar</button>
<button onclick="exportar()">Exportar CSV</button>
<button class="danger" onclick="zerar()">Zerar</button>
</div>

<div class="card">
<input id="codigo" placeholder="Bipar código aqui"/>
<button class="primary" onclick="bipar()">Adicionar</button>

<table>
<thead>
<tr>
<th>Código</th>
<th>Nome</th>
<th>Quantidade</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
const URL_JSON = "./produtos.json";
let base = [];
let inventario = {};
let posicaoAtual = "";

function normalizar(p){
return String(p||"").toUpperCase().replace(/-/g,"").trim();
}

function chaveStorage(p){
return "inv_"+normalizar(p);
}

async function carregarBase(){
const res = await fetch(URL_JSON);
base = await res.json();
}

function buscarPosicao(){
const pos = normalizar(document.getElementById("inputPosicao").value);
if(!pos){alert("Digite uma posição");return;}

posicaoAtual = pos;
document.getElementById("posicaoAtual").innerText = "Posição: "+pos;

inventario = {};

base.forEach(p=>{
if(normalizar(p.posicao) === pos){
inventario[p.codigo] = {
codigo:p.codigo,
nome:p.nome,
qtd:0
};
}
});

const salvo = localStorage.getItem(chaveStorage(pos));
if(salvo){
inventario = JSON.parse(salvo);
}

render();
}

function bipar(){
const cod = document.getElementById("codigo").value.trim();
if(!cod) return;

if(inventario[cod]){
inventario[cod].qtd += 1;
}else{
alert("Produto não pertence a essa posição!");
}

document.getElementById("codigo").value="";
render();
}

function render(){
const tbody = document.getElementById("tbody");
tbody.innerHTML="";

Object.values(inventario).forEach(item=>{
const tr = document.createElement("tr");
tr.innerHTML=`
<td>${item.codigo}</td>
<td>${item.nome}</td>
<td>${item.qtd}</td>
`;
tbody.appendChild(tr);
});
}

function salvar(){
if(!posicaoAtual){alert("Selecione uma posição");return;}
localStorage.setItem(chaveStorage(posicaoAtual), JSON.stringify(inventario));
alert("Salvo com sucesso!");
}

function zerar(){
if(!posicaoAtual) return;
if(confirm("Deseja zerar essa posição?")){
localStorage.removeItem(chaveStorage(posicaoAtual));
buscarPosicao();
}
}

function exportar(){
if(!posicaoAtual) return;

let linhas=["Codigo;Nome;Quantidade"];
Object.values(inventario).forEach(i=>{
linhas.push(`${i.codigo};${i.nome};${i.qtd}`);
});

const blob = new Blob(["\ufeff"+linhas.join("\n")],{type:"text/csv"});
const a = document.createElement("a");
a.href = URL.createObjectURL(blob);
a.download = "Inventario_"+posicaoAtual+".csv";
a.click();
}

carregarBase();
</script>

</body>
</html>
