<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Invent치rio - CD HMDK</title>
    <!-- Biblioteca para exporta칞칚o em Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Biblioteca para leitura de c칩digo de barras -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }
        
        .header {
            background: #1a73e8;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .content {
            padding: 20px;
        }
        
        .datetime-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .datetime-box {
            text-align: center;
            flex: 1;
        }
        
        .datetime-box:first-child {
            margin-right: 10px;
        }
        
        .datetime-label {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 5px;
        }
        
        .datetime-value {
            font-size: 18px;
            font-weight: bold;
            color: #1a73e8;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3c4043;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
            text-transform: uppercase;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .input-hint {
            font-size: 12px;
            color: #5f6368;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 25px;
        }
        
        button {
            flex: 1;
            min-width: 120px;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-finish-address {
            background-color: #f25c05;
            color: white;
        }
        
        .btn-finish-address:hover {
            background-color: #da5304;
        }
        
        .btn-finish {
            background-color: #34a853;
            color: white;
        }
        
        .btn-finish:hover {
            background-color: #2e8b47;
        }
        
        .btn-excel {
            background-color: #0b8043;
            color: white;
        }
        
        .btn-excel:hover {
            background-color: #096b38;
        }
        
        .btn-restart {
            background-color: #ea4335;
            color: white;
        }
        
        .btn-restart:hover {
            background-color: #d33426;
        }
        
        .btn-camera {
            background-color: #9c27b0;
            color: white;
        }
        
        .btn-camera:hover {
            background-color: #7b1fa2;
        }
        
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }
        
        .status.success {
            background-color: #e6f4ea;
            color: #137333;
            border: 1px solid #137333;
            display: block;
        }
        
        .status.error {
            background-color: #fce8e6;
            color: #c5221f;
            border: 1px solid #c5221f;
            display: block;
        }
        
        .counter {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            color: #5f6368;
        }
        
        .counter-number {
            font-weight: bold;
            color: #1a73e8;
            font-size: 24px;
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #5f6368;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal h2 {
            margin-bottom: 15px;
            color: #3c4043;
        }
        
        .modal p {
            margin-bottom: 20px;
            color: #5f6368;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .modal-btn.confirm {
            background-color: #ea4335;
            color: white;
        }
        
        .modal-btn.cancel {
            background-color: #f1f3f4;
            color: #3c4043;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            display: none;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #dadce0;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .valid {
            border-color: #34a853 !important;
        }
        
        .invalid {
            border-color: #ea4335 !important;
        }
        
        .table-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            display: none;
        }
        
        .table-container.visible {
            display: block;
        }
        
        .product-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #5f6368;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background-color: #1a73e8;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #1557b0;
        }
        
        .finalize-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .finalize-section.visible {
            display: block;
        }
        
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1001;
            flex-direction: column;
        }
        
        .camera-container {
            width: 100%;
            max-width: 500px;
            position: relative;
        }
        
        #camera-video {
            width: 100%;
            border-radius: 10px;
            background-color: black;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 2px solid #1a73e8;
            border-radius: 10px;
            box-sizing: border-box;
        }
        
        .camera-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .camera-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .camera-close {
            background-color: #ea4335;
            color: white;
        }
        
        .camera-switch {
            background-color: #5f6368;
            color: white;
        }
        
        .camera-flash {
            background-color: #1a73e8;
            color: white;
        }
        
        .scanner-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background-color: #1a73e8;
            box-shadow: 0 0 10px rgba(26, 115, 232, 0.7);
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }
        
        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
            }
            
            .product-info {
                flex-direction: column;
                gap: 5px;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .camera-container {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Invent치rio - CD HMDK</h1>
            <p>Controle de endere칞os e produtos</p>
        </div>
        
        <div class="content">
            <div class="datetime-container">
                <div class="datetime-box">
                    <div class="datetime-label">Data</div>
                    <div id="currentDate" class="datetime-value">01/01/2023</div>
                </div>
                <div class="datetime-box">
                    <div class="datetime-label">Hora</div>
                    <div id="currentTime" class="datetime-value">00:00:00</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="address">Endere칞o:</label>
                <input type="text" id="address" placeholder="Ex: 01-02-A2-21" maxlength="11">
                <div class="input-hint">Formato: 01-02-A2-21 (Dep칩sito-Rua-Pr칠dio-Apartamento)</div>
            </div>
            
            <div class="form-group">
                <label for="product">Produto:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="product" placeholder="Bipe o c칩digo do produto" disabled style="flex: 1;">
                    <button id="cameraBtn" class="btn-camera" disabled title="Ler c칩digo com a c칙mera">游닝</button>
                </div>
                <div class="input-hint">O c칩digo ser치 validado at칠 o primeiro "*" (se houver)</div>
            </div>
            
            <div class="counter">
                Produtos registrados: <span id="productCount" class="counter-number">0</span>
            </div>
            
            <div class="product-info">
                <div>Endere칞o atual: <span id="currentAddressDisplay">Nenhum</span></div>
                <div>Itens 칰nicos: <span id="uniqueProducts" class="counter-number">0</span></div>
            </div>
            
            <div id="status" class="status"></div>
            
            <div class="button-group">
                <button id="finishAddressBtn" class="btn-finish-address" disabled>Finalizar Endere칞o</button>
                <button id="finishBtn" class="btn-finish">Finalizar Contagem</button>
                <button id="excelBtn" class="btn-excel">Exportar Excel</button>
                <button id="restartBtn" class="btn-restart">Reiniciar</button>
            </div>
            
            <div id="finalizeSection" class="finalize-section">
                <h3>Contagem Finalizada</h3>
                <p>Total de <span id="finalProductCount" class="counter-number">0</span> produtos registrados em <span id="finalAddressCount" class="counter-number">0</span> endere칞os.</p>
                <div class="export-options">
                    <button id="exportExcelBtn" class="export-btn">Exportar para Excel</button>
                    <button id="newCountBtn" class="export-btn">Nova Contagem</button>
                </div>
            </div>
            
            <div id="tableContainer" class="table-container visible">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Endere칞o</th>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Data</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="instructions">
                <h3>Instru칞칫es de uso:</h3>
                <ul>
                    <li>Bipe o c칩digo do endere칞o (formato: 01-02-A2-21)</li>
                    <li>Bipe os c칩digos dos produtos no endere칞o (digite ou use a c칙mera)</li>
                    <li>Produtos iguais no mesmo endere칞o ser칚o agrupados automaticamente</li>
                    <li>Clique em "Finalizar Endere칞o" quando terminar o endere칞o atual</li>
                    <li>Clique em "Finalizar Contagem" para concluir todo o invent치rio</li>
                    <li>Use "Exportar Excel" para salvar o invent치rio</li>
                    <li>Use "Reiniciar" para limpar todos os dados (com confirma칞칚o)</li>
                    <li>Este app funciona perfeitamente em celulares Android e iOS</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma칞칚o -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmar reinicializa칞칚o</h2>
            <p>Digite <strong>excluir</strong> no campo abaixo para apagar todas as informa칞칫es:</p>
            <input type="text" id="confirmInput" class="modal-input" placeholder="Digite excluir">
            <div class="modal-buttons">
                <button id="cancelBtn" class="modal-btn cancel">Cancelar</button>
                <button id="confirmBtn" class="modal-btn confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal da C칙mera -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-container">
            <video id="camera-video" playsinline></video>
            <div class="camera-overlay">
                <div class="scanner-line"></div>
            </div>
        </div>
        <div class="camera-buttons">
            <button id="switchCameraBtn" class="camera-btn camera-switch">Trocar C칙mera</button>
            <button id="toggleFlashBtn" class="camera-btn camera-flash">Flash</button>
            <button id="closeCameraBtn" class="camera-btn camera-close">Fechar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos da interface
            const currentDateElem = document.getElementById('currentDate');
            const currentTimeElem = document.getElementById('currentTime');
            const addressInput = document.getElementById('address');
            const productInput = document.getElementById('product');
            const productCountElem = document.getElementById('productCount');
            const uniqueProductsElem = document.getElementById('uniqueProducts');
            const currentAddressDisplay = document.getElementById('currentAddressDisplay');
            const finishAddressBtn = document.getElementById('finishAddressBtn');
            const finishBtn = document.getElementById('finishBtn');
            const excelBtn = document.getElementById('excelBtn');
            const restartBtn = document.getElementById('restartBtn');
            const statusElem = document.getElementById('status');
            const confirmModal = document.getElementById('confirmModal');
            const confirmInput = document.getElementById('confirmInput');
            const cancelBtn = document.getElementById('cancelBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const dataTable = document.getElementById('dataTable');
            const tableBody = document.getElementById('tableBody');
            const tableContainer = document.getElementById('tableContainer');
            const finalizeSection = document.getElementById('finalizeSection');
            const finalProductCount = document.getElementById('finalProductCount');
            const finalAddressCount = document.getElementById('finalAddressCount');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const newCountBtn = document.getElementById('newCountBtn');
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraModal = document.getElementById('cameraModal');
            const cameraVideo = document.getElementById('camera-video');
            const switchCameraBtn = document.getElementById('switchCameraBtn');
            const toggleFlashBtn = document.getElementById('toggleFlashBtn');
            const closeCameraBtn = document.getElementById('closeCameraBtn');
            
            // Estado da aplica칞칚o
            let inventoryData = [];
            let currentAddress = '';
            let productCount = 0;
            let uniqueProducts = 0;
            let addressCount = 0;
            let isFinalized = false;
            let stream = null;
            let isCameraActive = false;
            let facingMode = 'environment'; // 'environment' (traseira) ou 'user' (frontal)
            let isFlashOn = false;
            let quaggaInitialized = false;
            
            // Focar no campo endere칞o
            function focusAddressField() {
                setTimeout(() => {
                    addressInput.focus();
                }, 100);
            }
            
            // Atualizar data e hora
            function updateDateTime() {
                const now = new Date();
                
                // Formatar data
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                currentDateElem.textContent = `${day}/${month}/${year}`;
                
                // Formatar hora
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                currentTimeElem.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            // Atualizar a cada segundo
            setInterval(updateDateTime, 1000);
            updateDateTime(); // Chamar imediatamente
            
            // Validar formato do endere칞o
            function isValidAddress(address) {
                const pattern = /^\d{2}-\d{2}-[A-Za-z]\d-\d{2}$/;
                return pattern.test(address);
            }
            
            // Formatar endere칞o automaticamente
            function formatAddress(input) {
                // Remove qualquer caractere que n칚o seja n칰mero, letra ou h칤fen
                let value = input.value.replace(/[^\dA-Za-z-]/g, '').toUpperCase();
                
                // Limita o comprimento
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // Adiciona h칤fens automaticamente
                if (value.length > 2 && value.charAt(2) !== '-') {
                    value = value.substring(0, 2) + '-' + value.substring(2);
                }
                if (value.length > 5 && value.charAt(5) !== '-') {
                    value = value.substring(0, 5) + '-' + value.substring(5);
                }
                if (value.length > 8 && value.charAt(8) !== '-') {
                    value = value.substring(0, 8) + '-' + value.substring(8);
                }
                
                input.value = value;
                return value;
            }
            
            // Validar e formatar c칩digo de barras (pegar apenas at칠 o primeiro *)
            function formatBarcode(barcode) {
                // Encontrar a posi칞칚o do primeiro *
                const asteriskIndex = barcode.indexOf('*');
                
                // Se encontrar *, pegar apenas a parte antes dele
                if (asteriskIndex !== -1) {
                    return barcode.substring(0, asteriskIndex).trim();
                }
                
                // Se n칚o encontrar *, retornar o c칩digo completo
                return barcode.trim();
            }
            
            // Mostrar status
            function showStatus(message, isSuccess) {
                statusElem.textContent = message;
                statusElem.className = isSuccess ? 'status success' : 'status error';
                
                // Ocultar ap칩s 5 segundos
                setTimeout(() => {
                    statusElem.className = 'status';
                }, 5000);
            }
            
            // Limpar todos os dados
            function clearAllData() {
                inventoryData = [];
                currentAddress = '';
                productCount = 0;
                uniqueProducts = 0;
                addressCount = 0;
                isFinalized = false;
                
                // Reiniciar interface
                addressInput.value = '';
                addressInput.disabled = false;
                addressInput.classList.remove('valid', 'invalid');
                productInput.value = '';
                productInput.disabled = true;
                cameraBtn.disabled = true;
                productCountElem.textContent = '0';
                uniqueProductsElem.textContent = '0';
                currentAddressDisplay.textContent = 'Nenhum';
                tableBody.innerHTML = '';
                tableContainer.classList.add('visible');
                finalizeSection.classList.remove('visible');
                finishAddressBtn.disabled = true;
                finishBtn.disabled = false;
                
                // Focar no campo endere칞o
                focusAddressField();
            }
            
            // Atualizar a tabela de visualiza칞칚o
            function updateTableView() {
                // Limpar tabela
                tableBody.innerHTML = '';
                
                // Agrupar produtos por endere칞o e c칩digo
                const groupedData = {};
                inventoryData.forEach(item => {
                    const key = `${item.address}-${item.product}`;
                    if (!groupedData[key]) {
                        groupedData[key] = {
                            address: item.address,
                            product: item.product,
                            quantity: 0,
                            date: item.date,
                            time: item.time
                        };
                    }
                    groupedData[key].quantity++;
                });
                
                // Adicionar itens agrupados  tabela
                Object.values(groupedData).forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${item.address}</td>
                        <td>${item.product}</td>
                        <td>${item.quantity}</td>
                        <td>${item.date}</td>
                        <td>${item.time}</td>
                    `;
                    tableBody.appendChild(newRow);
                });
                
                // Mostrar tabela se houver dados
                if (inventoryData.length > 0) {
                    tableContainer.classList.add('visible');
                } else {
                    tableContainer.classList.remove('visible');
                }
                
                // Atualizar contador de produtos 칰nicos
                uniqueProducts = Object.keys(groupedData).length;
                uniqueProductsElem.textContent = uniqueProducts;
            }
            
            // Exportar para Excel
            function exportToExcel() {
                if (inventoryData.length === 0) {
                    showStatus('Nenhum dado para exportar.', false);
                    return;
                }
                
                try {
                    // Agrupar produtos por endere칞o e c칩digo
                    const groupedData = {};
                    inventoryData.forEach(item => {
                        const key = `${item.address}-${item.product}`;
                        if (!groupedData[key]) {
                            groupedData[key] = {
                                Endere칞o: item.address,
                                Produto: item.product,
                                Quantidade: 0,
                                Data: item.date,
                                Hora: item.time
                            };
                        }
                        groupedData[key].Quantidade++;
                    });
                    
                    // Converter para array
                    const excelData = Object.values(groupedData);
                    
                    // Criar workbook e worksheet
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Invent치rio");
                    
                    // Formatar data para o nome do arquivo
                    const now = new Date();
                    const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                    
                    // Exportar para arquivo XLSX
                    XLSX.writeFile(wb, `inventario_${dateStr}.xlsx`);
                    
                    showStatus(`Excel exportado com ${uniqueProducts} itens 칰nicos.`, true);
                } catch (error) {
                    console.error("Erro ao exportar para Excel:", error);
                    showStatus('Erro ao exportar para Excel. Tente novamente.', false);
                }
            }
            
            // Finalizar contagem completa
            function finalizeCount() {
                if (inventoryData.length === 0) {
                    showStatus('Nenhum dado para finalizar.', false);
                    return;
                }
                
                // Calcular n칰mero de endere칞os 칰nicos
                const uniqueAddresses = new Set(inventoryData.map(item => item.address)).size;
                
                // Atualizar se칞칚o de finaliza칞칚o
                finalProductCount.textContent = inventoryData.length;
                finalAddressCount.textContent = uniqueAddresses;
                
                // Ocultar elementos de entrada e mostrar se칞칚o de finaliza칞칚o
                document.querySelectorAll('.form-group, .button-group, .counter, .product-info').forEach(el => {
                    el.style.display = 'none';
                });
                
                finalizeSection.classList.add('visible');
                isFinalized = true;
                
                showStatus('Contagem finalizada com sucesso!', true);
            }
            
            // Iniciar a c칙mera
            async function startCamera() {
                try {
                    cameraModal.style.display = 'flex';
                    
                    // Par칙metros para a c칙mera
                    const constraints = {
                        video: {
                            facingMode: facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    
                    // Solicitar acesso  c칙mera
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraVideo.srcObject = stream;
                    
                    // Iniciar a reprodu칞칚o do v칤deo
                    await cameraVideo.play();
                    
                    // Inicializar o Quagga para leitura de c칩digo de barras
                    if (!quaggaInitialized) {
                        Quagga.init({
                            inputStream: {
                                name: "Live",
                                type: "LiveStream",
                                target: cameraVideo,
                                constraints: constraints
                            },
                            decoder: {
                                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                            }
                        }, function(err) {
                            if (err) {
                                console.error("Erro ao inicializar Quagga:", err);
                                showStatus('Erro ao iniciar leitor de c칩digo de barras.', false);
                                return;
                            }
                            
                            Quagga.start();
                            quaggaInitialized = true;
                            
                            // Detectar c칩digos de barras
                            Quagga.onDetected(function(result) {
                                const code = result.codeResult.code;
                                if (code) {
                                    // Preencher o campo de produto com o c칩digo lido
                                    productInput.value = code;
                                    // Simular pressionar Enter para processar o c칩digo
                                    const event = new KeyboardEvent('keydown', { key: 'Enter' });
                                    productInput.dispatchEvent(event);
                                    
                                    // Parar temporariamente o scanner para evitar leituras m칰ltiplas
                                    Quagga.stop();
                                    setTimeout(() => {
                                        Quagga.start();
                                    }, 1000);
                                }
                            });
                        });
                    } else {
                        Quagga.start();
                    }
                    
                    isCameraActive = true;
                    
                } catch (error) {
                    console.error("Erro ao acessar a c칙mera:", error);
                    showStatus('N칚o foi poss칤vel acessar a c칙mera. Verifique as permiss칫es.', false);
                    stopCamera();
                }
            }
            
            // Parar a c칙mera
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                if (quaggaInitialized) {
                    Quagga.stop();
                }
                
                cameraModal.style.display = 'none';
                isCameraActive = false;
                
                // Voltar o foco para o campo de produto
                if (!isFinalized) {
                    productInput.focus();
                }
            }
            
            // Alternar entre c칙meras (frontal/traseira)
            async function switchCamera() {
                // Parar a c칙mera atual
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                if (quaggaInitialized) {
                    Quagga.stop();
                }
                
                // Alternar entre c칙meras
                facingMode = facingMode === 'environment' ? 'user' : 'environment';
                
                // Reiniciar a c칙mera
                await startCamera();
            }
            
            // Alternar flash (se dispon칤vel)
            async function toggleFlash() {
                if (!stream) return;
                
                const videoTrack = stream.getVideoTracks()[0];
                if (!videoTrack) return;
                
                try {
                    // Tentar acessar recursos de flash/torch
                    const capabilities = videoTrack.getCapabilities();
                    if (capabilities.torch) {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: !isFlashOn }]
                        });
                        isFlashOn = !isFlashOn;
                        toggleFlashBtn.textContent = isFlashOn ? 'Desligar Flash' : 'Flash';
                    } else {
                        showStatus('Flash n칚o dispon칤vel neste dispositivo.', false);
                    }
                } catch (error) {
                    console.error("Erro ao alternar flash:", error);
                    showStatus('N칚o foi poss칤vel alternar o flash.', false);
                }
            }
            
            // Processar endere칞o
            addressInput.addEventListener('input', function() {
                const value = formatAddress(addressInput);
                
                // Validar formato
                if (isValidAddress(value)) {
                    addressInput.classList.remove('invalid');
                    addressInput.classList.add('valid');
                    finishAddressBtn.disabled = false;
                } else {
                    addressInput.classList.remove('valid');
                    if (value.length > 0 && value.length >= 2) {
                        addressInput.classList.add('invalid');
                    } else {
                        addressInput.classList.remove('invalid');
                    }
                    finishAddressBtn.disabled = true;
                }
            });
            
            // Quando o endere칞o for preenchido corretamente
            addressInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && isValidAddress(addressInput.value)) {
                    currentAddress = addressInput.value;
                    currentAddressDisplay.textContent = currentAddress;
                    productInput.disabled = false;
                    cameraBtn.disabled = false;
                    productInput.focus();
                    addressInput.disabled = true;
                    showStatus('Endere칞o registrado. Agora biphe os produtos.', true);
                }
            });
            
            // Processar produto
            productInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && productInput.value.trim() !== '') {
                    const rawBarcode = productInput.value.trim();
                    const productCode = formatBarcode(rawBarcode);
                    
                    if (!productCode) {
                        showStatus('C칩digo de barras inv치lido.', false);
                        productInput.value = '';
                        return;
                    }
                    
                    const now = new Date();
                    const date = now.toLocaleDateString('pt-BR');
                    const time = now.toLocaleTimeString('pt-BR');
                    
                    // Adicionar aos dados
                    inventoryData.push({
                        address: currentAddress,
                        product: productCode,
                        date: date,
                        time: time
                    });
                    
                    // Atualizar contador
                    productCount++;
                    productCountElem.textContent = productCount;
                    
                    // Atualizar visualiza칞칚o da tabela
                    updateTableView();
                    
                    // Limpar campo e focar novamente
                    productInput.value = '';
                    showStatus(`Produto ${productCode} registrado no endere칞o ${currentAddress}`, true);
                }
            });
            
            // Finalizar endere칞o
            finishAddressBtn.addEventListener('click', function() {
                if (productCount === 0) {
                    showStatus('Nenhum produto foi registrado para este endere칞o.', false);
                    return;
                }
                
                // Reiniciar para novo endere칞o
                addressInput.value = '';
                addressInput.disabled = false;
                addressInput.classList.remove('valid', 'invalid');
                productInput.value = '';
                productInput.disabled = true;
                cameraBtn.disabled = true;
                focusAddressField();
                finishAddressBtn.disabled = true;
                
                addressCount++;
                showStatus(`Endere칞o ${currentAddress} finalizado com ${productCount} produtos.`, true);
                productCount = 0;
                productCountElem.textContent = '0';
                currentAddress = '';
                currentAddressDisplay.textContent = 'Nenhum';
            });
            
            // Finalizar contagem completa
            finishBtn.addEventListener('click', finalizeCount);
            
            // Exportar para Excel
            excelBtn.addEventListener('click', exportToExcel);
            
            // Exportar para Excel da tela final
            exportExcelBtn.addEventListener('click', exportToExcel);
            
            // Nova contagem
            newCountBtn.addEventListener('click', function() {
                clearAllData();
                document.querySelectorAll('.form-group, .button-group, .counter, .product-info').forEach(el => {
                    el.style.display = 'block';
                });
                showStatus('Nova contagem iniciada. Informe o primeiro endere칞o.', true);
            });
            
            // Abrir c칙mera
            cameraBtn.addEventListener('click', startCamera);
            
            // Fechar c칙mera
            closeCameraBtn.addEventListener('click', stopCamera);
            
            // Trocar c칙mera
            switchCameraBtn.addEventListener('click', switchCamera);
            
            // Alternar flash
            toggleFlashBtn.addEventListener('click', toggleFlash);
            
            // Abrir modal de confirma칞칚o para reiniciar
            restartBtn.addEventListener('click', function() {
                if (inventoryData.length === 0) {
                    showStatus('Nenhum dado para limpar.', false);
                    return;
                }
                
                confirmInput.value = '';
                confirmModal.style.display = 'flex';
                confirmInput.focus();
            });
            
            // Fechar modal
            cancelBtn.addEventListener('click', function() {
                confirmModal.style.display = 'none';
                if (!isFinalized) {
                    focusAddressField();
                }
            });
            
            // Confirmar reinicializa칞칚o
            confirmBtn.addEventListener('click', function() {
                if (confirmInput.value.toLowerCase() === 'excluir') {
                    // Limpar todos os dados
                    clearAllData();
                    
                    confirmModal.style.display = 'none';
                    
                    showStatus('Todos os dados foram apagados. Sistema reiniciado.', true);
                } else {
                    alert('Texto incorreto. Digite "excluir" para confirmar.');
                    confirmInput.focus();
                }
            });
            
            // Tecla Enter no modal de confirma칞칚o
            confirmInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    confirmBtn.click();
                }
            });
            
            // Focar no campo endere칞o ao carregar a p치gina
            focusAddressField();
        });
    </script>
</body>
</html>
